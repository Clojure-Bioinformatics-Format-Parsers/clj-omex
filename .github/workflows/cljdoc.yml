name: Generate and Publish Documentation

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

# Allow one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for git metadata
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Install Clojure tools
        uses: DeLaGuardo/setup-clojure@12.5
        with:
          cli: 'latest'
      
      - name: Cache Clojure dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.gitlibs
            ~/.clojure
          key: ${{ runner.os }}-clojure-${{ hashFiles('**/deps.edn') }}
          restore-keys: |
            ${{ runner.os }}-clojure-
      
      - name: Get project version
        id: version
        run: |
          # Extract version from git tag or use commit SHA
          if git describe --tags --exact-match 2>/dev/null; then
            VERSION=$(git describe --tags --exact-match | sed 's/^v//')
          else
            VERSION=$(git rev-parse --short HEAD)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Project version: $VERSION"
      
      - name: Create pom.xml
        run: |
          cat > pom.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <project xmlns="http://maven.apache.org/POM/4.0.0"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0
                                       http://maven.apache.org/xsd/maven-4.0.0.xsd">
            <modelVersion>4.0.0</modelVersion>
            <groupId>io.github.Clojure-Bioinformatics-Format-Parsers</groupId>
            <artifactId>clj-omex</artifactId>
            <version>${{ steps.version.outputs.version }}</version>
            <name>clj-omex</name>
            <description>A Clojure library for working with OMEX (Open Modeling EXchange) archive files</description>
            <url>https://github.com/Clojure-Bioinformatics-Format-Parsers/clj-omex</url>
            <licenses>
              <license>
                <name>Eclipse Public License 1.0</name>
                <url>http://opensource.org/licenses/eclipse-1.0.php</url>
              </license>
            </licenses>
            <scm>
              <url>https://github.com/Clojure-Bioinformatics-Format-Parsers/clj-omex</url>
              <connection>scm:git:git://github.com/Clojure-Bioinformatics-Format-Parsers/clj-omex.git</connection>
              <developerConnection>scm:git:ssh://git@github.com/Clojure-Bioinformatics-Format-Parsers/clj-omex.git</developerConnection>
            </scm>
            <dependencies>
              <dependency>
                <groupId>org.clojure</groupId>
                <artifactId>clojure</artifactId>
                <version>1.11.1</version>
              </dependency>
              <dependency>
                <groupId>org.clojure</groupId>
                <artifactId>data.xml</artifactId>
                <version>0.0.8</version>
              </dependency>
              <dependency>
                <groupId>org.clojure</groupId>
                <artifactId>data.zip</artifactId>
                <version>1.1.0</version>
              </dependency>
              <dependency>
                <groupId>org.apache.jena</groupId>
                <artifactId>jena-arq</artifactId>
                <version>4.10.0</version>
              </dependency>
            </dependencies>
          </project>
          EOF
      
      - name: Build JAR
        run: |
          # Create JAR with source files
          mkdir -p target
          jar -cf target/clj-omex-${{ steps.version.outputs.version }}.jar -C src .
      
      - name: Generate cljdoc documentation
        run: |
          # Create necessary directories
          mkdir -p cljdoc-data
          mkdir -p docs-output
          
          # Run cljdoc to ingest the project
          docker run --rm \
            -v "$PWD:/project" \
            -v "$PWD/cljdoc-data:/app/data" \
            cljdoc/cljdoc \
            clojure -A:cli ingest \
              --project io.github.Clojure-Bioinformatics-Format-Parsers/clj-omex \
              --version ${{ steps.version.outputs.version }} \
              --git /project \
              --pom /project/pom.xml \
              --jar /project/target/clj-omex-${{ steps.version.outputs.version }}.jar
      
      - name: Start cljdoc server
        run: |
          # Start cljdoc server in background
          docker run --rm -d \
            -p 8000:8000 \
            -v "$PWD/cljdoc-data:/app/data" \
            --name cljdoc-server \
            cljdoc/cljdoc
          
          # Wait for server to start
          echo "Waiting for cljdoc server to start..."
          for i in {1..30}; do
            if curl -f http://localhost:8000/ > /dev/null 2>&1; then
              echo "Server is ready!"
              break
            fi
            echo "Attempt $i: Server not ready yet..."
            sleep 2
          done
      
      - name: Export static documentation
        run: |
          # Use wget to mirror the documentation site
          wget --recursive --no-parent --no-host-directories \
            --cut-dirs=2 --page-requisites --convert-links \
            --adjust-extension --no-clobber \
            -P docs-output \
            -e robots=off \
            "http://localhost:8000/d/io.github.Clojure-Bioinformatics-Format-Parsers/clj-omex/${{ steps.version.outputs.version }}/"
          
          # Create an index.html redirect at root
          cat > docs-output/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>clj-omex Documentation</title>
            <meta http-equiv="refresh" content="0; url=./api/index.html">
          </head>
          <body>
            <h1>clj-omex Documentation</h1>
            <p>Redirecting to <a href="./api/index.html">API documentation</a>...</p>
          </body>
          </html>
          HTMLEOF
      
      - name: Stop cljdoc server
        if: always()
        run: |
          docker stop cljdoc-server || true
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'docs-output'
      
  deploy:
    needs: build
    runs-on: ubuntu-latest
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
